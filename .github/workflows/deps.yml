name: Create Internal Dependency Graph
on: [push]
jobs:
  run:
    name: Deps
    runs-on: [ubuntu-latest]
    steps:
    - uses: actions/checkout@master
    - uses: avsm/setup-ocaml@master
      with:
        ocaml-version: '4.09.0'
    - run: sudo apt-get update
    - run: sudo apt-get install graphviz
    - run: opam update
    - run: opam install dune-deps
    - run: opam exec -- dune-deps -x .git | tred | dot -Tpng > .deps.png
    - run: git remote add github "https://$GITHUB_ACTOR:$GITHUB_TOKEN@github.com/$GITHUB_REPOSITORY.git"
    - run: git pull github "$GITHUB_REF" --ff-only
    - run: git add .deps.png
    - run: git commit -m "Update dependency graph" .deps.png
    - run: git push github HEAD:"$GITHUB_REF"
